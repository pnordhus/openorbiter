#/bin/sh


function printhelp() {
	echo "Usage $1 [OPTION]..."
	echo
	echo "Options:"
	echo
	echo "  --prefix=PREFIX        architecture-independent files [/usr/local]"
	echo "  --exec-prefix=EPREFIX  architecture-dependent files [PREFIX]"
	echo
	echo "  --bindir=BINDIR        user executables [EPREFIX/bin]"
	echo "  --datadir=DATADIR      read-only data [PREFIX/share/openorbiter]"
	echo ""
	echo "  --enable-opengl        build with OpenGL support"
	echo "  --enable-debug         build with debug output"
	echo ""
	echo "  --help                 display this help and exit"
	echo ""
	exit 0
}


function printinvalid() {
	echo Invalid option passed: $1
	exit 1
}


function test_qt() {
	if [ -x "$1" ]; then
		return 0
	else
		return 1
	fi
}


OPENGL=""
DEBUG=""


for arg do
	opt=$(expr "x$arg" : 'x[^=]*=\(.*\)')

	case $arg in
	--help)
		printhelp $0
		;;
	--prefix=*)
		PREFIX=$opt
		;;
	--exec-prefix=*)
		EPREFIX=$opt
		;;
	--bindir=*)
		BINDIR=$opt
		;;
	--datadir=*)
		DATADIR=$opt
		;;
	--enable-opengl)
		OPENGL=1
		;;
	--enable-debug)
		DEBUG=1
		;;
	*)
		printinvalid $arg
		;;
	esac
done

QM_FOUND=""
QM="$QTDIR/bin/qmake"
if test_qt $QM; then
	QM_FOUND="1"
fi

if [ -z "$QM_FOUND" ]; then
	QM=$(type -p qmake)
	if test_qt $QM; then
		QM_FOUND="1"
	fi
fi

if [ -z "$QM_FOUND" ]; then
	echo "Qmake not found, or wrong version. You need Qt 4.0 or above."
	exit 1
fi

[ -z $PREFIX ] && PREFIX=/usr/local
[ -z $EPREFIX ] && EPREFIX=$PREFIX

[ -z $BINDIR ] && BINDIR=$EPREFIX/bin
[ -z $DATADIR ] && DATADIR=$PREFIX/share/openorbiter

mkdir -p build

echo "BINDIR  = $BINDIR"  >  build/configure.pri
echo "DATADIR = $DATADIR" >> build/configure.pri
if [ -n "$OPENGL" ]; then
	echo "QT += opengl" >> build/configure.pri
fi

if [ -n "$DEBUG" ]; then
	echo "CONFIG += debug" >> build/configure.pri
fi


echo "#ifndef CONFIG_H"              > build/configure.h
echo "#define CONFIG_H"             >> build/configure.h

echo "#define DATADIR \"$DATADIR\"" >> build/configure.h

echo "#endif"                       >> build/configure.h

"$QM"

echo Configuration complete
echo
echo "  BINDIR  = $BINDIR"
echo "  DATADIR = $DATADIR"

if [ -n "$OPENGL" ]; then
	echo "  Building with OpenGL support"
else
	echo "  Building without OpenGL support"
fi

if [ -n "$DEBUG" ]; then
	echo "  Building with debug output"
else
	echo "  Building without debug output"
fi

echo
